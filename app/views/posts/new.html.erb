<div class="container my-4">
  <h2 class="mb-4">お店を記録する</h2>

  <%= form_with(model: @post, local: true) do |f| %>
    <div class="mb-3">
      <label class="form-label">年月日</label>
      <div class="row">
        <div class="col-auto">
          <%= f.date_field :visit_date, class: 'form-control', style: 'width: 160px;' %>
        </div>
      </div>
    </div>

    <div class="mb-3" style="margin-top: 1.5rem;">
      <label class="form-label">お店の名前</label>
      <div class="row">
        <div class="col-auto">
          <%= f.text_field :shop_name, class: 'form-control' %>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">カテゴリ</label>
      <div class="row">
        <div class="col-auto">
          <%= f.collection_select :category_id, Category.all, :id, :name, { prompt: '選択してください' }, class: 'form-select' %>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">場所</label>
      <div class="row">
        <div class="col-auto">
          <%= f.collection_select :prefecture_id, Prefecture.all, :id, :name, 
                { prompt: '都道府県を選択' }, 
                { class: 'form-select', id: 'prefecture-select', style: 'min-width: 150px;' } %>
      </div>
    <div class="col-auto">
      <%= f.select :city_id, [], 
            { prompt: '都市を選択' }, 
            { class: 'form-select', id: 'city-select', style: 'min-width: 150px;' } %>
    </div>
  </div>
</div>

    <div class="mb-3">
      <label class="form-label">同行者</label>
      <div class="row">
        <div class="col-auto">
          <%= f.collection_select :companion_id, Companion.all, :id, :name, { prompt: '同行者を選択' }, class: 'form-select' %>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">気分</label>
      <div class="row">
        <div class="col-auto">
          <%= f.collection_select :feeling_id, Feeling.all, :id, :name, { prompt: '気分を選択' }, class: 'form-select' %>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">来店動機</label>
      <div class="row">
        <div class="col-auto">
          <%= f.collection_select :visit_reason_id, VisitReason.all, :id, :name, { prompt: '来店動機を選択' }, class: 'form-select' %>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">メモ</label>
      <div class="row">
        <div class="col-auto">
          <%= f.text_area :body, class: 'form-control', rows: 4, style: 'width: 400px;' %>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <%= f.label :post_image, class: "btn btn-outline-secondary", for: "post_image" do %>
        写真を追加
      <% end %>
      <%= f.file_field :post_image, id: "post_image", class: "d-none", accept: 'image/*' %>
      <%= f.hidden_field :post_image_cache %>
    </div>

    <div class="mb-3 text-end">
      <%= f.submit "お店を記録する", class: 'btn btn-danger text-white' %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const prefectureSelect = document.getElementById('prefecture-select');
    const citySelect = document.getElementById('city-select');

    if (!prefectureSelect || !citySelect) return;

    prefectureSelect.addEventListener('change', () => {
      const prefectureId = prefectureSelect.value;

      citySelect.innerHTML = '<option value="">都市を選択</option>';

      if (!prefectureId) return;

      fetch(`/cities.json?prefecture_id=${encodeURIComponent(prefectureId)}`)
        .then(response => response.json())
        .then(data => {
          data.forEach(city => {
            const option = document.createElement('option');
            option.value = city.id;
            option.textContent = city.name;
            citySelect.appendChild(option);
          });
        })
        .catch(error => console.error('都市の取得に失敗:', error));
    });
  });
</script>